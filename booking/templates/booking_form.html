
{% extends 'base.html' %}

{% block content %}
<style>
  .bt-card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(13, 37, 23, 0.06);
    padding: 22px;
    margin: 18px 0;
  }
  .bt-hero {
    background: linear-gradient(90deg,#1fa06a 0%, #2db07b 100%);
    color: #fff;
    padding: 18px 22px;
    border-radius: 12px;
    margin-bottom: 18px;
  }
  .bt-section-title {
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  .bt-section-title h3 { margin:0; font-size:1.05rem; color:#0b3f2a; }
  .user-info-grid {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  .field {
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-bottom:6px;
  }
  .field label { font-size:0.85rem; color:#2a6a4a; }
  .field input, .field select, .field textarea {
    border:1px solid #dfeee6;
    padding:10px 12px;
    border-radius:8px;
    background:#fbfffd;
    font-size:0.95rem;
    outline:none;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    box-shadow:0 0 0 3px rgba(37, 154, 100, 0.08);
    border-color:#2db07b;
  }
  .group-size {
    display:flex;
    align-items:center;
    gap:8px;
  }
  .qty-btn {
    background:#f1fbf6;
    border:1px solid #dfeee6;
    color:#177a4f;
    padding:6px 10px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }
  .submit-btn {
    background:#1fa06a;
    color:white;
    padding:12px 18px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    font-weight:700;
    box-shadow:0 6px 16px rgba(31,160,106,0.18);
  }
  .anggota { border:1px dashed #e3f5ea; padding:12px; border-radius:10px; margin-bottom:12px; background:#fcfffc;}
  .anggota h4 { margin:0 0 8px 0; color:#16663f; font-size:0.98rem; }
  @media (max-width:700px){
    .user-info-grid { grid-template-columns: 1fr; }
  }
</style>

<div class="bt-hero">
  <h2 style="margin:0; font-weight:700;">
    Booking Pendakian — 
    {% if gunung %}
      {{ gunung.nama }}
    {% else %}
      -
    {% endif %}
  </h2>
  <div style="opacity:0.95; margin-top:6px;">Isi identitas grup dan anggota untuk melanjutkan pemesanan</div>
</div>

<div class="bt-card">
  <div class="bt-section-title">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden><circle cx="12" cy="12" r="10" fill="#e9f8ef"/></svg>
    <h3>Your Information</h3>
  </div>

  <div class="user-info-grid" style="margin-bottom:12px;">
    <div class="field">
      <label>Nama</label>
      <input type="text" value="{{ user_profile.nama }}" readonly>
    </div>
    <div class="field">
      <label>Umur</label>
      <input type="text" value="{{ user_profile.umur }}" readonly>
    </div>
    <div class="field">
      <label>Jenis Kelamin</label>
      <input type="text" value="{{ user_profile.get_jenis_kelamin_display }}" readonly>
    </div>
    <div class="field">
      <label>Pengalaman</label>
      <input type="text" value="{{ user_profile.get_category_experience_display }}" readonly>
    </div>
  </div>

  <form method="POST" id="booking-form" class="bt-form">
    {% csrf_token %}

    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
      <div>
        <label style="display:block; font-size:0.9rem; color:#2a6a4a; margin-bottom:6px;">Jumlah Anggota</label>
        <div class="group-size">
          <button type="button" id="dec" class="qty-btn">−</button>
          {{ form.pax }}
          <button type="button" id="inc" class="qty-btn">+</button>
          <button type="button" id="generate-anggota" class="qty-btn" style="margin-left:8px;">Terapkan</button>
        </div>
      </div>

      <div style="min-width:220px;">
        <label style="display:block; font-size:0.9rem; color:#2a6a4a; margin-bottom:6px;">Sewa Porter</label>
        {{ form.porter_hire }}
      </div>
    </div>

    <h3 style="margin-top:6px; color:#16663f;">Detail Anggota</h3>
    <div id="anggota-container">
      {% if anggota_fields %}
        {% for anggota in anggota_fields %}
          <div class="anggota">
            <h4>Anggota {{ forloop.counter }}</h4>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              {% if anggota.name %}<div class="field">{{ anggota.name.label_tag }} {{ anggota.name }}</div>{% endif %}
              {% if anggota.age %}<div class="field">{{ anggota.age.label_tag }} {{ anggota.age }}</div>{% endif %}
              {% if anggota.gender %}<div class="field">{{ anggota.gender.label_tag }} {{ anggota.gender }}</div>{% endif %}
              {% if anggota.level %}<div class="field">{{ anggota.level.label_tag }} {{ anggota.level }}</div>{% endif %}
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:10px;">
      <div style="color:#6a8b74; font-size:0.9rem;">Pastikan data anggota lengkap sebelum submit.</div>
      <button type="submit" class="submit-btn">Submit Booking</button>
    </div>
  </form>
</div>

<!-- store server-side porter error in data-attribute to avoid template tags inside JS -->
<div id="bt-toast"
     data-porter-error="{% if form.errors.porter_hire %}{{ form.errors.porter_hire.0|escapejs }}{% endif %}"
     style="position:fixed;right:18px;bottom:18px;z-index:9999;pointer-events:none;"></div>

<script>
(function(){
  const dec = document.getElementById('dec');
  const inc = document.getElementById('inc');
  const btn = document.getElementById('generate-anggota');
  const paxInput = document.getElementById('id_pax');
  const container = document.getElementById('anggota-container');
  const formEl = document.getElementById('booking-form');

  function mkLabel(text, forId) {
    const lab = document.createElement('label');
    if (forId) lab.htmlFor = forId;
    lab.textContent = text;
    lab.style.fontSize = '0.9rem';
    lab.style.color = '#2a6a4a';
    return lab;
  }

  function mkInput(name, type='text', id=null) {
    const inp = document.createElement('input');
    inp.name = name;
    inp.type = type;
    if (id) inp.id = id;
    inp.required = true;
    inp.style.padding = '10px';
    inp.style.borderRadius = '8px';
    inp.style.border = '1px solid #dfeee6';
    inp.style.width = '100%';
    return inp;
  }

  function mkSelect(name, choices, id=null) {
    const sel = document.createElement('select');
    sel.name = name;
    if (id) sel.id = id;
    sel.required = true;
    sel.style.padding = '10px';
    sel.style.borderRadius = '8px';
    sel.style.border = '1px solid #dfeee6';
    sel.style.width = '100%';
    choices.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c[0];
      opt.textContent = c[1];
      sel.appendChild(opt);
    });
    return sel;
  }

  function generate(n) {
    container.innerHTML = '';
    n = Math.max(1, Math.floor(n) || 1);
    for (let i = 0; i < n; i++) {
      const wrap = document.createElement('div');
      wrap.className = 'anggota';
      wrap.style.marginBottom = '12px';

      const h = document.createElement('h4');
      h.textContent = 'Anggota ' + (i+1);
      h.style.marginTop = '0';
      wrap.appendChild(h);

      const grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = '1fr 1fr';
      grid.style.gap = '10px';

      const nameWrap = document.createElement('div');
      const nameLabel = mkLabel('Nama', 'id_anggota_'+i+'_name');
      nameWrap.appendChild(nameLabel);
      nameWrap.appendChild(mkInput('anggota_'+i+'_name', 'text', 'id_anggota_'+i+'_name'));
      grid.appendChild(nameWrap);

      const ageWrap = document.createElement('div');
      const ageLabel = mkLabel('Usia', 'id_anggota_'+i+'_age');
      ageWrap.appendChild(ageLabel);
      const ageInput = mkInput('anggota_'+i+'_age', 'number', 'id_anggota_'+i+'_age');
      ageInput.min = 0;
      ageWrap.appendChild(ageInput);
      grid.appendChild(ageWrap);

      const genderWrap = document.createElement('div');
      const genderLabel = mkLabel('Jenis Kelamin', 'id_anggota_'+i+'_gender');
      genderWrap.appendChild(genderLabel);
      genderWrap.appendChild(mkSelect('anggota_'+i+'_gender', [['M','Laki-laki'],['F','Perempuan']], 'id_anggota_'+i+'_gender'));
      grid.appendChild(genderWrap);

      const levelWrap = document.createElement('div');
      const levelLabel = mkLabel('Level', 'id_anggota_'+i+'_level');
      levelWrap.appendChild(levelLabel);
      levelWrap.appendChild(mkSelect('anggota_'+i+'_level', [['beginner','Beginner'],['intermediate','Intermediate'],['advanced','Advanced']], 'id_anggota_'+i+'_level'));
      grid.appendChild(levelWrap);

      wrap.appendChild(grid);
      container.appendChild(wrap);
    }
  }

  // toast helper
  function showToast(message, opts = {}) {
    const toastRoot = document.getElementById('bt-toast');
    if (!toastRoot) return;
    const t = document.createElement('div');
    t.textContent = message;
    t.style.background = opts.bg || '#ff6b6b';
    t.style.color = '#fff';
    t.style.padding = '10px 14px';
    t.style.marginTop = '8px';
    t.style.borderRadius = '8px';
    t.style.boxShadow = '0 6px 18px rgba(0,0,0,0.08)';
    t.style.pointerEvents = 'auto';
    t.style.opacity = '0';
    t.style.transition = 'opacity 220ms, transform 220ms';
    toastRoot.appendChild(t);
    requestAnimationFrame(()=>{ t.style.opacity = '1'; t.style.transform = 'translateY(-6px)'; });
    const ttl = opts.ttl || 3500;
    setTimeout(()=> {
      t.style.opacity = '0';
      t.style.transform = 'translateY(0)';
      setTimeout(()=> toastRoot.removeChild(t), 260);
    }, ttl);
  }

  // inc/dec handlers
  if (inc) inc.addEventListener('click', () => {
    let v = parseInt(paxInput.value) || 1; v = Math.min(10, v+1); paxInput.value = v;
  });
  if (dec) dec.addEventListener('click', () => {
    let v = parseInt(paxInput.value) || 1; v = Math.max(1, v-1); paxInput.value = v;
  });

  // initial render from server pax
  try {
    const initialPax = parseInt('{{ pax|default:1 }}');
    if (!isNaN(initialPax) && container && (!container.children.length || container.children.length === 0)) {
      generate(initialPax);
    }
  } catch(e){ /* ignore */ }

  if (btn) btn.addEventListener('click', function(e){
    const val = parseInt(paxInput.value) || 1;
    generate(val);
    setTimeout(()=>{ container.scrollIntoView({behavior:'smooth', block:'start'}); }, 80);
  });

  // submit guard: kalau semua anggota beginner, wajib pilih porter_hire == 'yes'
  if (formEl) {
    formEl.addEventListener('submit', function(e){
      const selects = Array.from(document.querySelectorAll('select[name$="_level"]'));
      const levels = selects.map(s => s.value).filter(v => v !== null && v !== '');
      if (levels.length === 0) return; // tidak ada anggota, biarkan server validation
      const allBeginner = levels.every(l => l === 'beginner');
      const porterSelect = document.getElementById('id_porter_hire') || document.querySelector('select[name="porter_hire"], input[name="porter_hire"]');
      const porterVal = porterSelect ? porterSelect.value : '';
      if (allBeginner && porterVal !== 'yes') {
        e.preventDefault();
        showToast('Semua anggota berlevel Beginner — Anda diwajibkan memilih Sewa Porter (Ya).', {});
        if (porterSelect) porterSelect.scrollIntoView({behavior:'smooth', block:'center'});
        return false;
      }
    });
  }

  // show server-side porter error (read from data attribute)
  document.addEventListener('DOMContentLoaded', function () {
    const toastRoot = document.getElementById('bt-toast');
    const porterErr = toastRoot && toastRoot.dataset ? toastRoot.dataset.porterError : '';
    if (porterErr) {
      setTimeout(()=> showToast(porterErr, { bg: '#f86b6b' }), 80);
    }
  });
})();
</script>
{% endblock %}
