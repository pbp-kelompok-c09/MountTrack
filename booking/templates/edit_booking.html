{% extends 'base.html' %}

{% block content %}
<style>
  .bt-card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(13, 37, 23, 0.06);
    padding: 22px;
    margin: 18px 0;
  }
  .bt-hero {
    background: linear-gradient(90deg,#1fa06a 0%, #2db07b 100%);
    color: #fff;
    padding: 18px 22px;
    border-radius: 12px;
    margin-bottom: 18px;
  }
  .bt-section-title {
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  .bt-section-title h3 { margin:0; font-size:1.05rem; color:#0b3f2a; }
  .user-info-grid {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  .field {
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-bottom:6px;
  }
  .field label { font-size:0.85rem; color:#2a6a4a; }
  .field input, .field select, .field textarea {
    border:1px solid #dfeee6;
    padding:10px 12px;
    border-radius:8px;
    background:#fbfffd;
    font-size:0.95rem;
    outline:none;
  }
  .field input:focus, .field select:focus, .field textarea:focus {
    box-shadow:0 0 0 3px rgba(37, 154, 100, 0.08);
    border-color:#2db07b;
  }
  .group-size {
    display:flex;
    align-items:center;
    gap:8px;
  }
  .qty-btn {
    background:#f1fbf6;
    border:1px solid #dfeee6;
    color:#177a4f;
    padding:6px 10px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }
  .submit-btn {
    background:#1fa06a;
    color:white;
    padding:12px 18px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    font-weight:700;
    box-shadow:0 6px 16px rgba(31,160,106,0.18);
  }
  .anggota { border:1px dashed #e3f5ea; padding:12px; border-radius:10px; margin-bottom:12px; background:#fcfffc;}
  .anggota h4 { margin:0 0 8px 0; color:#16663f; font-size:0.98rem; }
  @media (max-width:700px){
    .user-info-grid { grid-template-columns: 1fr; }
  }
</style>

<div class="bt-hero">
  <h2 style="margin:0; font-weight:700;">
    Edit Booking — 
    {% if gunung %}
      {{ gunung.nama }}
    {% else %}
      -
    {% endif %}
  </h2>
  <div style="opacity:0.95; margin-top:6px;">Update your booking details below</div>
</div>

<div class="bt-card">
  <div class="bt-section-title">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden><circle cx="12" cy="12" r="10" fill="#e9f8ef"/></svg>
    <h3>Your Information</h3>
  </div>

  <div class="user-info-grid" style="margin-bottom:12px;">
    <div class="field">
      <label>Nama</label>
      <input type="text" value="{{ user_profile.nama }}" readonly>
    </div>
    <div class="field">
      <label>Umur</label>
      <input type="text" value="{{ user_profile.umur }}" readonly>
    </div>
    <div class="field">
      <label>Jenis Kelamin</label>
      <input type="text" value="{{ user_profile.get_jenis_kelamin_display }}" readonly>
    </div>
    <div class="field">
      <label>Pengalaman</label>
      <input type="text" value="{{ user_profile.get_category_experience_display }}" readonly>
    </div>
  </div>

  <form method="POST" id="booking-form" class="bt-form">
    {% csrf_token %}

    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
      <div>
        <label style="display:block; font-size:0.9rem; color:#2a6a4a; margin-bottom:6px;">Jumlah Anggota</label>
        <div class="group-size">
          <button type="button" id="dec" class="qty-btn">−</button>
          {{ form.pax }}
          <button type="button" id="inc" class="qty-btn">+</button>
          <button type="button" id="generate-anggota" class="qty-btn" style="margin-left:8px;">Terapkan</button>
        </div>
      </div>

      <div style="min-width:220px;">
        <label style="display:block; font-size:0.9rem; color:#2a6a4a; margin-bottom:6px;">Sewa Porter</label>
        {{ form.porter_hire }}
      </div>
    </div>

    <h3 style="margin-top:6px; color:#16663f;">Detail Anggota</h3>
    <div id="anggota-container">
      {% if anggota_fields %}
        {% for anggota in anggota_fields %}
          <div class="anggota">
            <h4>Anggota {{ forloop.counter }}</h4>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              {% if anggota.name %}<div class="field">{{ anggota.name.label_tag }} {{ anggota.name }}</div>{% endif %}
              {% if anggota.age %}<div class="field">{{ anggota.age.label_tag }} {{ anggota.age }}</div>{% endif %}
              {% if anggota.gender %}<div class="field">{{ anggota.gender.label_tag }} {{ anggota.gender }}</div>{% endif %}
              {% if anggota.level %}<div class="field">{{ anggota.level.label_tag }} {{ anggota.level }}</div>{% endif %}
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:10px;">
      <div style="color:#6a8b74; font-size:0.9rem;">Pastikan data anggota lengkap sebelum submit.</div>
      <button type="submit" class="submit-btn">Submit Booking</button>
    </div>
  </form>
</div>

<script>
// Implement the dynamic "Jumlah Anggota" field increment/decrement
(function(){
  const dec = document.getElementById('dec');
  const inc = document.getElementById('inc');
  const btn = document.getElementById('generate-anggota');
  const paxInput = document.getElementById('id_pax');
  const container = document.getElementById('anggota-container');
  const formEl = document.getElementById('booking-form');

  function generate(n) {
    container.innerHTML = '';
    n = Math.max(1, Math.floor(n) || 1);
    for (let i = 0; i < n; i++) {
      const wrap = document.createElement('div');
      wrap.className = 'anggota';
      wrap.style.marginBottom = '12px';

      const h = document.createElement('h4');
      h.textContent = 'Anggota ' + (i+1);
      h.style.marginTop = '0';
      wrap.appendChild(h);

      const grid = document.createElement('div');
      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = '1fr 1fr';
      grid.style.gap = '10px';

      const nameWrap = document.createElement('div');
      const nameLabel = mkLabel('Nama', 'id_anggota_'+i+'_name');
      nameWrap.appendChild(nameLabel);
      nameWrap.appendChild(mkInput('anggota_'+i+'_name', 'text', 'id_anggota_'+i+'_name'));
      grid.appendChild(nameWrap);

      const ageWrap = document.createElement('div');
      const ageLabel = mkLabel('Usia', 'id_anggota_'+i+'_age');
      ageWrap.appendChild(ageLabel);
      const ageInput = mkInput('anggota_'+i+'_age', 'number', 'id_anggota_'+i+'_age');
      ageInput.min = 0;
      ageWrap.appendChild(ageInput);
      grid.appendChild(ageWrap);

      const genderWrap = document.createElement('div');
      const genderLabel = mkLabel('Jenis Kelamin', 'id_anggota_'+i+'_gender');
      genderWrap.appendChild(genderLabel);
      genderWrap.appendChild(mkSelect('anggota_'+i+'_gender', [['M','Laki-laki'],['F','Perempuan']], 'id_anggota_'+i+'_gender'));
      grid.appendChild(genderWrap);

      const levelWrap = document.createElement('div');
      const levelLabel = mkLabel('Level', 'id_anggota_'+i+'_level');
      levelWrap.appendChild(levelLabel);
      levelWrap.appendChild(mkSelect('anggota_'+i+'_level', [['beginner','Beginner'],['intermediate','Intermediate'],['advanced','Advanced']], 'id_anggota_'+i+'_level'));
      grid.appendChild(levelWrap);

      wrap.appendChild(grid);
      container.appendChild(wrap);
    }
  }

  // inc/dec handlers
  if (inc) inc.addEventListener('click', () => {
    let v = parseInt(paxInput.value) || 1; v = Math.min(10, v+1); paxInput.value = v;
  });
  if (dec) dec.addEventListener('click', () => {
    let v = parseInt(paxInput.value) || 1; v = Math.max(1, v-1); paxInput.value = v;
  });

  // apply button to generate
  if (btn) btn.addEventListener('click', function(e){
    const val = parseInt(paxInput.value) || 1;
    generate(val);
    setTimeout(()=>{ container.scrollIntoView({behavior:'smooth', block:'start'}); }, 80);
  });
})();
</script>

{% endblock %}
