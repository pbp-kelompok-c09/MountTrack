<h2>Buat Berita Baru</h2>

<form method="POST" novalidate>
    {% csrf_token %}
    
    <h3>Detail Berita</h3>
    {{ news_form.as_p }}
    
    <hr>
    
    <h3>Gambar Tambahan</h3>
    
    {{ image_formset.management_form }}
    
    <div id="image-form-list">
        {% for form in image_formset %}
            <div class="image-form">
                
                <p>
                    {{ form.image_url.label_tag }}
                    {{ form.image_url }}
                    {{ form.image_url.errors }}
                </p>

                {{ form.id }}

                {% if form.instance.pk and image_formset.can_delete %}
                    <label>
                        Hapus Gambar Ini: {{ form.DELETE }}
                    </label>
                {% endif %}
                </div>
            <br>
        {% endfor %}
    </div>
    
    <button type="button" id="add-image-form" class="btn btn-secondary btn-sm">+ Tambah Gambar Lain</button>
    
    <hr>
    
    <button type="submit" class="btn btn-primary">Simpan Berita</button>
</form>

<div id="empty-form-template" style="display: none;">
    <div class="image-form">
        <p>
            {{ image_formset.empty_form.image_url.label_tag }}
            {{ image_formset.empty_form.image_url }}
        </p>
        <button type="button" class="remove-image-form btn btn-danger btn-sm">Hapus Gambar Ini</button>
    </div>
    <br>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const addFormBtn = document.getElementById('add-image-form');
    const formList = document.getElementById('image-form-list');
    const template = document.getElementById('empty-form-template').innerHTML;
    const totalFormsInput = document.getElementById('id_images-TOTAL_FORMS');

    addFormBtn.addEventListener('click', function() {
        let currentFormCount = parseInt(totalFormsInput.value);
        const newFormHtml = template.replace(/__prefix__/g, currentFormCount);
        formList.insertAdjacentHTML('beforeend', newFormHtml);
        totalFormsInput.value = currentFormCount + 1;
    });

    // Event listener untuk tombol hapus (yang dibuat oleh JS)
    formList.addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-image-form')) {
            // Temukan 'image-form' terdekat dan hapus
            const formWrapper = event.target.closest('.image-form');
            if (formWrapper) {
                const br = formWrapper.nextElementSibling; // Hapus <br> setelahnya
                if(br && br.tagName === 'BR') {
                    br.remove();
                }
                formWrapper.remove();
                
                // PENTING: Kita tidak perlu mengurangi TOTAL_FORMS.
                // Django cukup pintar untuk menangani form yang 'hilang'
                // selama ID-nya tidak ada (karena ini form baru).
            }
        }
    });
});
</script>